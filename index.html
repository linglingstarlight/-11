<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>網路交友安全辨識遊戲（馬卡龍版）</title>
<style>
  :root{
    --bg:#fffaf6;
    --card:#ffffff;
    --muted:#6b7280;
    --text:#241332;
    --radius:14px;
    --shadow-soft:0 10px 30px rgba(36,19,50,0.06);
    --maxw:980px;
    --player-bubble-bg: #e0efff;
    --player-text: #0b3e2f;
    --border-strong: rgba(0,0,0,0.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg),#fbfbff); color:var(--text); -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%;}
  html, body { overflow-x: hidden; }

  .page{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;}
  .container{width:100%; max-width:var(--maxw);}

  .gameCard{background:var(--card); border-radius:18px; padding:12px; box-shadow:var(--shadow-soft); overflow:auto; display:grid; grid-template-rows:auto 1fr auto auto; gap:12px; position:relative; max-height:calc(100vh - 32px); border:1px solid var(--border-strong); margin:auto; width:100%; max-width:100%; }
  h1{margin:0; font-size:20px; text-align:center}
  p.lead{margin:0;color:var(--muted); font-size:14px; text-align:center}

  /* HOME */
  #home{display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; padding:18px 12px; min-height:220px}
  .home-avatars{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap }
  .home-avatar{ width:64px; height:64px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:28px; box-shadow:0 6px 18px rgba(36,19,50,0.04); border:1px solid var(--border-strong); background:linear-gradient(135deg,#ffffff, #fffaf6); }
  .home-avatar .label{ display:block; font-size:12px; color:var(--muted); margin-top:6px; text-align:center }
  #startBtn{ padding:12px 18px; border-radius:12px; font-weight:800; background:linear-gradient(90deg,#ffd6a5,#fff0d6); color:var(--text); border:1px solid rgba(0,0,0,0.06); box-shadow:0 8px 26px rgba(111,66,193,0.06); cursor:pointer }

  /* header - desktop layout: left avatar/name, center title, right score+sound */
  #opponentHeader{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px; border:1px solid var(--border-strong); background:linear-gradient(180deg,#fff,#fffaf6); flex-wrap:nowrap}
  .op-left{display:flex;align-items:center;gap:12px; flex-shrink:0; min-width:0}
  .op-avatar{width:52px;height:52px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px; box-shadow:0 6px 18px rgba(36,19,50,0.04); border:1px solid var(--border-strong); flex-shrink:0;}
  .op-name{font-weight:800}
  .opSubtitle{font-size:13px;color:var(--muted); font-weight:700}
  .op-center{flex:1; text-align:center; min-width:0}
  .op-center h2{margin:0; font-size:16px; white-space:normal; word-break:break-word}
  .op-right{ min-width:160px; text-align:right; display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-shrink:0 }

  /* sound button inline */
  .sound-inline{ min-width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--border-strong); background:var(--card); cursor:pointer; font-size:18px; padding:6px; flex-shrink:0; }
  .sound-inline.muted{ background:#fff }
  .sound-inline.on{ background: linear-gradient(90deg,#c7b8ff,#e6d8ff); }

  /* score */
  #scoreDisplay{ background:#fff; border-radius:12px; padding:8px 12px; box-shadow:var(--shadow-soft); font-weight:900; font-size:16px; color:var(--text); border:1px solid var(--border-strong); }

  /* chat */
  .chatAreaWrap{border-radius:12px; overflow:hidden; border:1px solid var(--border-strong); background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,1)); display:flex; flex-direction:column; min-height:0; width:100%; overflow-x:hidden; }
  .chat{padding:12px 14px; overflow:auto; background:transparent; display:block; min-height:0; -webkit-overflow-scrolling:touch; width:100%; }
  .msgRow{display:flex; margin:8px 0; align-items:flex-end; gap:10px; width:100%}
  .msgBubble{padding:10px 14px; border-radius:14px; max-width:72%; word-break:break-word; box-shadow: 0 6px 18px rgba(2,6,23,0.04); border:1px solid rgba(0,0,0,0.06); overflow-wrap: break-word;}
  .msgBubble { max-width: calc(100vw - 140px); }
  .playerBubble{ background: linear-gradient(180deg, var(--player-bubble-bg), #cfeeff); color:var(--player-text); margin-left:auto; border-top-right-radius:6px; max-width: calc(100vw - 120px); }

  /* typing bubble */
  .typingBubble{ border-radius:12px; padding:10px 12px; display:inline-flex; align-items:center; gap:10px; border:2px solid rgba(0,0,0,0.06); max-width: calc(100vw - 140px); }
  .typingText{font-size:13px;color:var(--muted); font-weight:700}
  .dots{display:inline-flex; gap:6px}
  .dots span{ display:inline-block; width:8px; height:8px; border-radius:50%; background:rgba(36,19,50,0.16); transform:translateY(0); animation:dot 1s infinite; }
  @keyframes dot{ 0%{opacity:0.3; transform:translateY(0);} 50%{opacity:1; transform:translateY(-6px);} 100%{opacity:0.3; transform:translateY(0);} }

  /* controls */
  #controlArea{display:flex; gap:10px; align-items:center; padding:10px 0; flex-wrap:wrap}
  #playerInput{flex:1; min-width:0; padding:12px 14px;border-radius:12px;border:1px solid var(--border-strong); background:linear-gradient(180deg,#fff,#fffaf8); caret-color:var(--text); font-size:15px}
  #playerInput.noCaret{ caret-color: transparent; }
  #sendBtn{background:linear-gradient(90deg,#c7b8ff,#e6d8ff); color:var(--text); border:1px solid var(--border-strong); padding:10px 14px; border-radius:12px}
  button.small{padding:8px 10px; border-radius:10px; display:inline-flex; gap:8px; align-items:center; cursor:pointer; border:1px solid var(--border-strong); background:var(--card)}
  .btnIcon{width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:14px; border:1px solid var(--border-strong)}
  .btnLabel{ font-weight:800; margin-left:8px; font-size:14px; white-space:nowrap; }
  .safeIcon{background:linear-gradient(90deg,#b8f2d0,#9fe9c6); color:#064e3b}
  .dangerIcon{background:linear-gradient(90deg,#ffd6d6,#ffb4b4); color:#7f1d1d}
  .small.btn-correct{ background:linear-gradient(90deg,#d7fbe6,#b8f2d0); border-color:rgba(30,150,110,0.22); }
  .small.btn-wrong{ background:linear-gradient(90deg,#ffdede,#ffb4b4); border-color:rgba(220,80,80,0.18); }

  /* footer */
  .gameFooter{display:flex; gap:12px; align-items:flex-start; margin-top:8px; padding:6px}
  #dangerBoard{flex:1; padding:12px; background:linear-gradient(180deg,#fff7f7,#fff5f5); border:1px solid rgba(239,68,68,0.06); border-radius:12px; min-height:64px; color:#7f1d1d; overflow:auto; white-space:pre-wrap; word-break:break-word; max-height:160px}
  @media (max-width:520px){ #dangerBoard{ max-height:120px; width:100%; } .gameFooter{flex-direction:column;} }
  #levelEndNotice{min-width:220px; padding:12px; border-radius:12px; background:linear-gradient(180deg,#f3f0ff,#f9f7ff); border:1px solid rgba(111,66,193,0.06); color:var(--text); font-weight:700; display:none}

  /* next button */
  #nextBtn{position:fixed; right:22px; bottom:22px; z-index:200; display:none; padding:12px 20px; border-radius:14px; border:1px solid var(--border-strong); background:linear-gradient(90deg,#c7b8ff,#e6d8ff); color:var(--text); box-shadow:0 18px 46px rgba(111,66,193,0.12); font-weight:800}
  @media (max-width:520px){ #nextBtn{ position:static; display:none; margin-top:8px; align-self:flex-end } .op-center h2{ white-space:normal; } .op-right{ min-width:0; flex-direction:row-reverse; gap:8px } #scoreDisplay{ font-size:13px } }

  #restartFinalBtn{ background:linear-gradient(90deg,#ffd6a5,#fff0d6); color:var(--text); border:1px solid var(--border-strong); padding:10px 14px; border-radius:12px; font-weight:800 }

  /* confetti */
  #confetti{ position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:hidden; z-index:450 }
  .confetti-piece{ position:fixed; will-change:transform, top, opacity; border-radius:2px }

  /* MOBILE: stack header to save vertical space; title single-line */
  @media (max-width:520px){
    #opponentHeader{ flex-direction:column; align-items:center; gap:8px; padding:10px; }
    .op-center{ order:0; width:100%; }
    .op-center h2{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:15px; }
    .op-left{ order:1; display:flex; width:100%; justify-content:center; gap:8px; }
    .op-right{ order:2; display:flex; width:100%; justify-content:center; gap:8px; }
    .btnLabel{ margin-left:6px; font-size:13px; }
    .btnIcon{ width:26px; height:26px; font-size:13px; }
    #playerInput{ font-size:15px; padding:10px 12px; }
    #controlArea{ gap:8px; align-items:center; }
    .msgBubble, .typingBubble { max-width: calc(100vw - 60px); }
  }

  /* landscape small safety */
  @media (max-width:760px) and (orientation: landscape) {
    #opponentHeader { gap:6px; padding:8px; }
    .op-center h2 { font-size:14px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .msgBubble{ max-width: calc(100vw - 80px); }
    #playerInput{ max-width: calc(100% - 140px); }
    #nextBtn{ position:static; }
  }

  /* small visual hint for safeFocus */
  #playerInput.focus-hint { box-shadow: 0 0 0 8px rgba(99,102,241,0.08); transition: box-shadow 0.28s; }
</style>
</head>
<body>
<div class="page">
  <div class="container">
    <div id="gameCard" class="gameCard" role="main">

      <!-- HOME -->
      <div id="home">
        <div style="text-align:center">
          <h1>網路交友安全辨識遊戲</h1>
          <p class="lead">練習判斷對話中的風險，保護個人資料與隱私。</p>
        </div>

        <div class="home-avatars" id="homeList" aria-hidden="false"></div>

        <div style="display:flex; gap:12px; justify-content:center; margin-top:8px">
          <button id="startBtn">開始遊戲</button>
        </div>
      </div>

      <!-- GAME -->
      <div id="game" style="display:none" aria-labelledby="levelTitle">

        <!-- DESKTOP ORDER: left (avatar/name), center (title), right (score/sound) -->
        <div id="opponentHeader">
          <div class="op-left">
            <div id="opAvatar" class="op-avatar">🐱</div>
            <div style="display:flex; flex-direction:column;">
              <div id="opName" class="op-name">網友1</div>
              <div class="opSubtitle" id="opSubtitle">線上</div>
            </div>
          </div>
          <div class="op-center"><h2 id="levelTitle">關卡</h2></div>
          <div class="op-right">
            <div id="scoreDisplay">本關分數: 0 | 累積分數: 0</div>
            <button id="soundBtn" class="sound-inline muted" title="切換音效"><span id="soundIcon">🔇</span></button>
          </div>
        </div>

        <div class="chatAreaWrap">
          <div class="chat" id="chatArea" aria-live="polite"></div>
        </div>

        <div id="controlArea">
          <button id="safeBtn" class="small"><span class="btnIcon safeIcon">✓</span><span class="btnLabel">安全</span></button>
          <button id="dangerBtn" class="small"><span class="btnIcon dangerIcon">!</span><span class="btnLabel">危險</span></button>
          <input id="playerInput" type="text" class="noCaret" placeholder="先按安全或危險，再輸入回覆" disabled />
          <button id="sendBtn">送出</button>
        </div>

        <div class="gameFooter">
          <div id="dangerBoard" aria-live="polite">暫無危險提示</div>
          <div id="levelEndNotice">本關已結束，請按「下一關」。</div>
        </div>

        <button id="nextBtn">下一關</button>
      </div>

      <!-- RESULT -->
      <div id="result" style="display:none">
        <h2>遊戲結束 🎉</h2>
        <div id="finalScore" style="font-weight:800; margin-bottom:8px;"></div>
        <div id="finalMessage" style="margin-bottom:10px; font-weight:700;"></div>
        <div style="margin-bottom:10px;"><button id="restartFinalBtn">回到首頁</button></div>
        <h3 style="margin-bottom:8px">危險對話提醒（所有危險對話，含原因）</h3>
        <div id="dangerSummary" style="white-space:pre-line; padding:12px; background:#fff8f8; border:1px solid #f87171; border-radius:8px; max-height:60vh; overflow:auto;"></div>
      </div>

    </div>
  </div>
</div>

<div id="confetti"></div>

<!-- Audios -->
<audio id="bgMusic" loop src="assets/audio/strawberry-358303.mp3"></audio>
<audio id="correctSound" src="assets/audio/correct.mp3"></audio>
<audio id="wrongSound" src="assets/audio/error.mp3"></audio>
<audio id="perfectSound" src="assets/audio/perfect.mp3"></audio>
<audio id="multiPop" src="assets/audio/multi-pop.mp3"></audio>

<script>
/* 關卡資料（不變） */
const levelData = [
  { title:'第一關', opponent:{name:'網友1', avatar:'🐱', color:'#ffcced'}, dialogues:[
      { text:'嗨！剛剛看到你分享的跑步照片，很有活力，你常去哪裡跑步？', danger:false },
      { text:'我上週參加學校的路跑，想知道你平常訓練怎麼安排？', danger:false },
      { text:'可以把你的比賽成績給我看看嗎？我想比較一下。', danger:true, reason:'比賽成績屬個人資訊，可能被用來評價或追蹤' }
    ], answers:[], score:0 },
  { title:'第二關', opponent:{name:'網友2', avatar:'🐶', color:'#bfeaff'}, dialogues:[
      { text:'嗨～今天有沒有發生什麼好玩的事？', danger:false },
      { text:'我跟朋友想週末去附近那家咖啡廳，你會去嗎？', danger:false },
      { text:'如果你住附近，可以拍一下你家外面的街景給我看嗎？', danger:false }
    ], answers:[], score:0 },
  { title:'第三關', opponent:{name:'網友3', avatar:'🦊', color:'#c8facc'}, dialogues:[
      { text:'你的自拍很有特色，最近在用哪個濾鏡？', danger:false },
      { text:'可以給我一張你單獨的私密自拍嗎？我很想看真實的你～', danger:true, reason:'要求私人照片可能導致濫用或外流' },
      { text:'如果不方便也沒關係，我們可以多聊聊興趣。', danger:false }
    ], answers:[], score:0 },
  { title:'第四關', opponent:{name:'網友4', avatar:'🐼', color:'#fff6b3'}, dialogues:[
      { text:'嗨，我們隊缺一個隊友玩合作遊戲，你想加入嗎？', danger:false },
      { text:'我們通常周末練一小時，大家都很友善。', danger:false },
      { text:'請問你的遊戲暱稱是什麼？（不是帳號或密碼）', danger:false }
    ], answers:[], score:0 },
  { title:'第五關', opponent:{name:'網友5', avatar:'🦄', color:'#ffd1ba'}, dialogues:[
      { text:'你最近最喜歡的科目是什麼？', danger:false },
      { text:'這周末有社團活動，會有很多同學出席，想一塊去嗎？', danger:false },
      { text:'你現在有在交往嗎？可以告訴我對方的名字嗎？', danger:true, reason:'詢問感情私人資訊不適合公開' }
    ], answers:[], score:0 }
];

let currentLevel=0, currentDialogue=0, choiceMade=false, cumulativeScore=0;
let soundEnabled=false, confettiActive=false;

/* audios */
const bgMusic = document.getElementById('bgMusic');
const correctSound = document.getElementById('correctSound');
const wrongSound = document.getElementById('wrongSound');
const perfectSound = document.getElementById('perfectSound');
const multiPop = document.getElementById('multiPop');

/* dom */
const gameCard=document.getElementById('gameCard');
const homeEl=document.getElementById('home'), gameEl=document.getElementById('game'), resultEl=document.getElementById('result');
const startBtn=document.getElementById('startBtn');
const opAvatarEl=document.getElementById('opAvatar'), opNameEl=document.getElementById('opName'), opSubtitle=document.getElementById('opSubtitle');
const chatArea=document.getElementById('chatArea'), playerInput=document.getElementById('playerInput'), sendBtn=document.getElementById('sendBtn');
const safeBtn=document.getElementById('safeBtn'), dangerBtn=document.getElementById('dangerBtn');
const dangerBoard=document.getElementById('dangerBoard'), levelEndNotice=document.getElementById('levelEndNotice');
const scoreDisplay=document.getElementById('scoreDisplay'), nextBtn=document.getElementById('nextBtn');
const resultScore=document.getElementById('finalScore'), resultMsg=document.getElementById('finalMessage'), dangerSummary=document.getElementById('dangerSummary');
const restartFinalBtn=document.getElementById('restartFinalBtn');
const soundBtn=document.getElementById('soundBtn');
const soundIcon=document.getElementById('soundIcon');
const homeList=document.getElementById('homeList');
const confettiEl=document.getElementById('confetti');

/* helpers */
function darken(hex, amt){ const h=hex.replace('#',''); const bigint=parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h,16); const r=(bigint>>16)&255,g=(bigint>>8)&255,b=bigint&255; const nr=Math.max(0,Math.min(255,Math.round(r*(1-amt)))), ng=Math.max(0,Math.min(255,Math.round(g*(1-amt)))), nb=Math.max(0,Math.min(255,Math.round(b*(1-amt)))); return `rgba(${nr},${ng},${nb},1)`; }
function rgba(hex,a){ const h=hex.replace('#',''); const bigint=parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h,16); const r=(bigint>>16)&255,g=(bigint>>8)&255,b=bigint&255; return `rgba(${r},${g},${b},${a})`; }

/* auto-focus helper: short delay + scroll-into-view protection */
function isMobileDevice(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }
function safeFocus(el, opts = { delay: 300 }){
  if(!el) return;
  const d = typeof opts.delay === 'number' ? opts.delay : 300;
  setTimeout(()=>{
    try{
      el.focus();
      if(typeof el.scrollIntoView === 'function'){
        el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
      }
      if(isMobileDevice()){
        el.classList.add('focus-hint');
        setTimeout(()=> el.classList.remove('focus-hint'), 1500);
      }
    }catch(e){
      try{ el.focus(); }catch(err){}
    }
  }, d);
}

/* render home avatars */
function renderHomeAvatars(){ homeList.innerHTML=''; levelData.forEach((l,i)=>{ const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='center'; wrap.style.gap='6px'; const w=document.createElement('div'); w.className='home-avatar'; w.style.background = `linear-gradient(135deg, ${l.opponent.color}, #ffffffcc)`; w.style.border = '1px solid var(--border-strong)'; w.innerText = l.opponent.avatar; const label = document.createElement('div'); label.className='label'; label.innerText = '網友' + (i+1); label.style.fontSize='12px'; label.style.color='var(--muted)'; wrap.appendChild(w); wrap.appendChild(label); homeList.appendChild(wrap); }); }

/* UI states */
function showHome(){ homeEl.style.display='flex'; gameEl.style.display='none'; resultEl.style.display='none'; scoreDisplay.style.display='none'; soundBtn.style.display='none'; gameCard.style.paddingBottom='16px'; renderHomeAvatars(); setTimeout(()=>{ gameCard.scrollTop = 0; }, 50); }
function showGame(){ homeEl.style.display='none'; gameEl.style.display='block'; resultEl.style.display='none'; scoreDisplay.style.display='block'; soundBtn.style.display='inline-flex'; setTimeout(()=>{ gameCard.scrollTop = 0; }, 50); }
function showResult(){ homeEl.style.display='none'; gameEl.style.display='none'; resultEl.style.display='block'; scoreDisplay.style.display='none'; soundBtn.style.display='inline-flex'; gameCard.style.paddingBottom='16px'; setTimeout(()=>{ gameCard.scrollTop = 0; }, 50); }

/* chat append */
function appendNpcWithTyping(text, avatar){
  if(!dangerBoard.innerText) dangerBoard.innerText='暫無危險提示';
  const row=document.createElement('div'); row.className='msgRow';
  const avatarWrap=document.createElement('div'); avatarWrap.className='op-avatar'; avatarWrap.innerText=avatar;
  avatarWrap.style.background = window.currentNpcColor ? `linear-gradient(135deg, ${window.currentNpcColor}, #ffffffcc)` : '';
  const bubble=document.createElement('div'); bubble.className='typingBubble';
  const typingText=document.createElement('div'); typingText.className='typingText'; typingText.innerText='對方正在輸入…';
  const dots=document.createElement('div'); dots.className='dots'; dots.innerHTML='<span></span><span></span><span></span>';
  bubble.appendChild(typingText); bubble.appendChild(dots);
  const col = window.currentNpcColor || '#e9eef8';
  bubble.style.background = `linear-gradient(180deg, ${col}, #ffffffcc)`;
  bubble.style.border = `2px solid ${rgba(darken(col,0.18),0.22)}`;
  row.appendChild(avatarWrap); row.appendChild(bubble); chatArea.appendChild(row);
  const base=600, perChar=30, maxTime=2200; const time=Math.min(base + (text.length * perChar), maxTime);
  return new Promise(resolve=>{ setTimeout(()=>{ bubble.className='msgBubble npcBubble'; bubble.innerText=text; bubble.style.background = `linear-gradient(180deg, ${col}, #ffffffcc)`; bubble.style.borderLeft = `4px solid ${rgba(darken(col,0.18),0.28)}`; const nearBottom = (chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight) < 80; if(nearBottom) chatArea.scrollTop = chatArea.scrollHeight; playSound(multiPop); resolve(); }, time); });
}

function appendPlayer(text){ const row=document.createElement('div'); row.className='msgRow'; const bubble=document.createElement('div'); bubble.className='msgBubble playerBubble'; bubble.innerText=text; row.appendChild(bubble); row.style.justifyContent='flex-end'; chatArea.appendChild(row); chatArea.scrollTop = chatArea.scrollHeight; playSound(multiPop); }

function updateScoreDisplay(){ const level=levelData[currentLevel]||{}; const cs=level.score||0; scoreDisplay.innerText=`本關分數: ${cs} | 累積分數: ${cumulativeScore}`; }

function setOpponentStyle(color){ const darker=darken(color,0.18); const header=document.getElementById('opponentHeader'); header.style.background=`linear-gradient(90deg, ${rgba(darker,0.12)}, rgba(255,255,255,0))`; opAvatarEl.style.background=`linear-gradient(135deg, ${color}, #ffffffcc)`; opAvatarEl.style.border='1px solid var(--border-strong)'; window.currentNpcColor=color; }

function loadLevel(){
  chatArea.innerHTML=''; dangerBoard.innerText='暫無危險提示'; nextBtn.style.display='none'; levelEndNotice.style.display='none';
  playerInput.value=''; playerInput.disabled=true; playerInput.readOnly=true; playerInput.classList.add('noCaret');
  safeBtn.classList.remove('btn-correct','btn-wrong'); dangerBtn.classList.remove('btn-correct','btn-wrong');
  choiceMade=false; currentDialogue=0;
  const level=levelData[currentLevel];
  opAvatarEl.innerText=level.opponent.avatar; opNameEl.innerText=level.opponent.name; opSubtitle.innerText='線上';
  setOpponentStyle(level.opponent.color);
  const titleEl=document.getElementById('levelTitle'); const titleText=`${level.title}（第 ${currentLevel+1} 關 / 共 ${levelData.length} 關）`;
  titleEl.innerText=titleText; titleEl.title=titleText;
  updateScoreDisplay();
  appendNpcWithTyping(level.dialogues[currentDialogue].text, level.opponent.avatar).then(()=>{});
}

/* handle choice */
function handleChoice(isDanger){
  if(choiceMade) return;
  choiceMade=true;
  const level=levelData[currentLevel];
  const dlg=level.dialogues[currentDialogue];
  const correct=(dlg.danger===isDanger);
  level.answers[currentDialogue]=correct;
  if(correct){
    playSound(correctSound);
  } else {
    playSound(wrongSound);
    if(dlg.danger && !isDanger){
      const tip=`❌ 第${currentDialogue+1}題：${dlg.text}\n其實這是危險的，原因：${dlg.reason||'無'}\n\n`;
      dangerBoard.innerText = (dangerBoard.innerText==='暫無危險提示'?'':dangerBoard.innerText) + tip;
      dangerBoard.scrollTop = dangerBoard.scrollHeight;
      showToast('發現未注意到的危險 — 已在提醒區記錄',2200);
    }
    if(!dlg.danger && isDanger){
      showToast('判斷為「危險」但此回應實際為安全 — 此誤判不會列入關卡總結',3600);
    }
  }
  const btn=isDanger?dangerBtn:safeBtn;
  safeBtn.classList.remove('btn-correct','btn-wrong'); dangerBtn.classList.remove('btn-correct','btn-wrong');
  btn.classList.add(correct? 'btn-correct' : 'btn-wrong');

  playerInput.disabled=false; playerInput.readOnly=false; playerInput.classList.remove('noCaret');
  safeFocus(playerInput, { delay: 300 });
}

/* send input */
function sendPlayerInput(){
  if(!choiceMade) return;
  const val=playerInput.value.trim(); if(!val) return;
  appendPlayer(val);
  playerInput.value=''; playerInput.disabled=true; playerInput.readOnly=true; playerInput.classList.add('noCaret');
  safeBtn.classList.remove('btn-correct','btn-wrong'); dangerBtn.classList.remove('btn-correct','btn-wrong');
  choiceMade=false; currentDialogue++;
  const level=levelData[currentLevel];
  if(currentDialogue<level.dialogues.length){
    appendNpcWithTyping(level.dialogues[currentDialogue].text, level.opponent.avatar).then(()=>{});
  } else {
    const allCorrect = level.answers.length===level.dialogues.length && level.answers.every(x=>x===true);
    level.score = allCorrect ? 20 : 0;
    if(allCorrect){ playSound(perfectSound); showConfetti(); }
    cumulativeScore += level.score;
    updateScoreDisplay();
    let errors=''; level.dialogues.forEach((d,i)=>{ if(d.danger && !level.answers[i]) { errors+=`❌ 第${i+1}題：${d.text} 原因：${d.reason||'無'}\n\n`; } });
    dangerBoard.innerText = errors || '本關無錯誤！';
    dangerBoard.scrollTop = dangerBoard.scrollHeight;
    if(currentLevel < levelData.length - 1){
      nextBtn.style.display='block'; levelEndNotice.style.display='block'; levelEndNotice.innerText='本關已結束，請按「下一關」。';
      if(window.matchMedia('(max-width:520px)').matches){ nextBtn.style.position='static'; } else { nextBtn.style.position='fixed'; gameCard.style.paddingBottom='120px'; }
      nextBtn.dataset.type='next'; nextBtn.innerText='下一關'; nextBtn.focus();
    } else {
      nextBtn.style.display='block'; levelEndNotice.style.display='block'; levelEndNotice.innerText='遊戲已結束，請按「遊戲結束」。';
      nextBtn.dataset.type='finish'; nextBtn.innerText='遊戲結束';
      if(window.matchMedia('(max-width:520px)').matches){ nextBtn.style.position='static'; } else { nextBtn.style.position='fixed'; gameCard.style.paddingBottom='120px'; }
      nextBtn.focus();
    }
  }
}

/* confetti */
function showConfetti(){ confettiActive=true; confettiEl.innerHTML=''; const colors=['#ff7ab6','#ffd166','#c7f9cc','#a7d8ff','#ffd1ba','#e6d8ff']; const rows=5; const perRow=24; for(let r=0;r<rows;r++){ const delayBase = r * 120; for(let i=0;i<perRow;i++){ const e=document.createElement('div'); e.className='confetti-piece'; const left = (i/perRow*100) + (Math.random()*3); e.style.left = left + '%'; e.style.top = (-10 - r*6) + 'vh'; e.style.width = (6 + Math.random()*14) + 'px'; e.style.height = (8 + Math.random()*26) + 'px'; e.style.background = colors[Math.floor(Math.random()*colors.length)]; e.style.opacity = 0.95; e.style.transform = 'rotate('+(Math.random()*360)+'deg)'; e.style.transition = `transform 3.4s linear ${delayBase}ms, top 3.4s linear ${delayBase}ms, opacity 3.4s linear ${delayBase}ms`; confettiEl.appendChild(e); setTimeout(()=>{ try{ e.style.top = (110 + Math.random()*10) + 'vh'; e.style.transform = 'rotate('+(720+Math.random()*720)+'deg)'; e.style.opacity = 0.95; }catch(err){} }, 50 + delayBase); setTimeout(()=>{ try{ if(confettiEl.contains(e)) confettiEl.removeChild(e); }catch(err){} }, 3800 + delayBase); } } setTimeout(()=>{ confettiActive=false; gameCard.style.paddingBottom='16px'; }, 5000); }

function playSound(el){ if(!soundEnabled) return; try{ const src = el && el.getAttribute && el.getAttribute('src'); if(!src) return; const s = new Audio(src); s.volume = 0.24; s.play().catch(()=>{}); }catch(e){} }

function saveRecordAndShowResult(){ let summary=''; levelData.forEach((lvl,li)=>{ lvl.dialogues.forEach((d,di)=>{ if(d.danger){ const answered=Array.isArray(lvl.answers)?!!lvl.answers[di]:false; summary+=`第${li+1}關 第${di+1}題: ${d.text}\n⚠️ 危險原因: ${d.reason||'無'}\n判斷: ${answered? '✅ 你判斷為危險 (正確)' : '❌ 你判斷錯誤或未判斷為危險'}\n\n`; } }); }); resultScore.innerText=`你的總分是：${cumulativeScore}`; const normalized = [0,20,40,60,80,100].includes(cumulativeScore) ? cumulativeScore : (cumulativeScore<20?0:(cumulativeScore<40?20:(cumulativeScore<60?40:(cumulativeScore<80?60:(cumulativeScore<100?80:100))))); const feedbacks = { 0: {title:'分數：0 — 再加油！', msg:'多注意個人資料與私密照片保護，請避免分享具有識別性的資訊。', tips:['不要分享地址、學校或比賽成績等定位資訊','遇到要求私人照片或詳細地址時應立即停止分享','使用平台內的匿名或私密設定保護個資']}, 20: {title:'分數：20 — 還可以更好', msg:'留心對方要求的個人資訊，別輕易分享。', tips:['對於不熟悉的人，保持基本禮貌但保留個資','遇到要求實體地址或私密照片時多問問題並保持距離','可使用模糊照片或不透露細節來保護隱私']}, 40: {title:'分數：40 — 做得不錯', msg:'已有警覺，但還有需要加強的地方。', tips:['注意對方是否持續索取更多私密資訊','定期檢視與刪除不必要的個人分享內容','若對方有威脅或恐嚇行為，立即停止並截圖存證']}, 60: {title:'分數：60 — 很好', msg:'有注意到多數危險訊號，繼續保持。', tips:['使用隱私設定限制看到你詳細訊息的人','當有人要求見面或索取照片時，先在平台上多聊與核實對方身分','與朋友討論可疑情況，尋求第二意見']}, 80: {title:'分數：80 — 非常棒！', msg:'已具備良好網路安全觀念。', tips:['持續維持界線，不要因為讚美或壓力而分享私密資訊','教會身邊人同樣的守則','當你發現他人受騙，提供合適協助與檢舉']}, 100: {title:'分數：100 — 完美！', msg:'完全判斷正確，恭喜你！', tips:['你已具備優秀的網路安全意識','分享這些觀念給身邊人','保持警覺心並鼓勵他人一起學習']} }; const fb = feedbacks[normalized] || feedbacks[0]; resultMsg.innerText = fb.title + '\n' + fb.msg + '\n\n建議:\n' + fb.tips.map((t,i)=>`${i+1}. ${t}`).join('\n'); dangerSummary.innerText = summary || '沒有危險對話'; if(normalized === 100){ playSound(perfectSound); showConfetti(); } showResult(); }

/* toast */
function showToast(msg,duration=3000){ let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='24px'; t.style.transform='translateX(-50%)'; t.style.background='rgba(36,19,50,0.95)'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='12px'; t.style.zIndex=9999; document.body.appendChild(t); } t.innerText=msg; t.style.display='block'; clearTimeout(t._timer); t._timer=setTimeout(()=>{ t.style.display='none'; }, duration); }

/* events */
const startBtnEl = document.getElementById('startBtn');
startBtnEl.addEventListener('click', ()=>{
  levelData.forEach(l=>{ l.answers=[]; l.score=0; });
  currentLevel=0; currentDialogue=0; choiceMade=false; cumulativeScore=0;
  soundEnabled = true;
  if(soundBtn){ soundBtn.classList.remove('muted'); soundBtn.classList.add('on'); soundBtn.setAttribute('aria-pressed','true'); }
  if(soundIcon) soundIcon.innerText = '🔊';
  try{ bgMusic.volume=0.08; bgMusic.play().catch(()=>{}); }catch(e){}
  showGame(); loadLevel();
});

soundBtn.addEventListener('click', ()=>{ soundEnabled=!soundEnabled; if(soundEnabled){ soundBtn.classList.remove('muted'); soundBtn.classList.add('on'); soundBtn.setAttribute('aria-pressed','true'); if(soundIcon) soundIcon.innerText='🔊'; try{ bgMusic.volume=0.08; bgMusic.play().catch(()=>{}); }catch(e){} } else { soundBtn.classList.remove('on'); soundBtn.classList.add('muted'); soundBtn.setAttribute('aria-pressed','false'); if(soundIcon) soundIcon.innerText='🔇'; try{ bgMusic.pause(); bgMusic.currentTime=0; }catch(e){} } });

safeBtn.addEventListener('click', ()=>handleChoice(false));
dangerBtn.addEventListener('click', ()=>handleChoice(true));
sendBtn.addEventListener('click', sendPlayerInput);
playerInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendPlayerInput(); });

nextBtn.addEventListener('click', ()=>{ const t = nextBtn.dataset.type || 'next'; if(t === 'next'){ if(confettiActive){ confettiActive=false; confettiEl.innerHTML=''; setTimeout(()=>{ nextBtn.style.display='none'; gameCard.style.paddingBottom='16px'; currentLevel++; loadLevel(); },120); } else { nextBtn.style.display='none'; gameCard.style.paddingBottom='16px'; currentLevel++; loadLevel(); } } else { if(confettiActive){ confettiActive=false; confettiEl.innerHTML=''; setTimeout(()=>{ saveRecordAndShowResult(); },120); } else saveRecordAndShowResult(); } });

restartFinalBtn.addEventListener('click', ()=>{ levelData.forEach(l=>{ l.answers=[]; l.score=0; }); currentLevel=0; currentDialogue=0; choiceMade=false; cumulativeScore=0; try{ bgMusic.pause(); bgMusic.currentTime=0; }catch(e){} soundEnabled=false; if(soundBtn){ soundBtn.classList.remove('on'); soundBtn.classList.add('muted'); if(soundIcon) soundIcon.innerText='🔇'; } showHome(); });

/* init */
renderHomeAvatars(); showHome();

/* resize safety */
window.addEventListener('resize', ()=>{ try{ if(nextBtn.style.display==='block' && nextBtn.dataset.type){ if(!window.matchMedia('(max-width:520px)').matches) gameCard.style.paddingBottom='120px'; } }catch(e){} });

</script>
</body>
</html>
