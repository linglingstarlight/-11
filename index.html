<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç¶²è·¯äº¤å‹å®‰å…¨è¾¨è­˜éŠæˆ²ï¼ˆé¦¬å¡é¾ç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#fffaf6;
    --card:#ffffff;
    --muted:#6b7280;
    --text:#241332;
    --radius:14px;
    --shadow-soft:0 10px 30px rgba(36,19,50,0.06);
    --maxw:980px;
    --player-bubble-bg: #e0efff;
    --player-text: #0b3e2f;
    --border-strong: rgba(0,0,0,0.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg),#fbfbff); color:var(--text); -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%;}
  html, body { overflow-x: hidden; }

  .page{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;}
  .container{width:100%; max-width:var(--maxw);}

  .gameCard{background:var(--card); border-radius:18px; padding:12px; box-shadow:var(--shadow-soft); overflow:auto; display:grid; grid-template-rows:auto 1fr auto auto; gap:12px; position:relative; max-height:calc(100vh - 32px); border:1px solid var(--border-strong); margin:auto; width:100%; max-width:100%; }
  h1{margin:0; font-size:20px; text-align:center}
  p.lead{margin:0;color:var(--muted); font-size:14px; text-align:center}

  /* HOME */
  #home{display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; padding:18px 12px; min-height:220px}
  .home-avatars{ display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap }
  .home-avatar{ width:64px; height:64px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:28px; box-shadow:0 6px 18px rgba(36,19,50,0.04); border:1px solid var(--border-strong); background:linear-gradient(135deg,#ffffff, #fffaf6); }
  .home-avatar .label{ display:block; font-size:12px; color:var(--muted); margin-top:6px; text-align:center }
  #startBtn{ padding:12px 18px; border-radius:12px; font-weight:800; background:linear-gradient(90deg,#ffd6a5,#fff0d6); color:var(--text); border:1px solid rgba(0,0,0,0.06); box-shadow:0 8px 26px rgba(111,66,193,0.06); cursor:pointer }

  /* header - desktop layout: left avatar/name, center title, right score+sound */
  #opponentHeader{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px; border:1px solid var(--border-strong); background:linear-gradient(180deg,#fff,#fffaf6); flex-wrap:nowrap}
  .op-left{display:flex;align-items:center;gap:12px; flex-shrink:0; min-width:0}
  .op-avatar{width:52px;height:52px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px; box-shadow:0 6px 18px rgba(36,19,50,0.04); border:1px solid var(--border-strong); flex-shrink:0;}
  .op-name{font-weight:800}
  .opSubtitle{font-size:13px;color:var(--muted); font-weight:700}
  .op-center{flex:1; text-align:center; min-width:0}
  .op-center h2{margin:0; font-size:16px; white-space:normal; word-break:break-word}
  .op-right{ min-width:160px; text-align:right; display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-shrink:0 }

  /* sound button inline */
  .sound-inline{ min-width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--border-strong); background:var(--card); cursor:pointer; font-size:18px; padding:6px; flex-shrink:0; }
  .sound-inline.muted{ background:#fff }
  .sound-inline.on{ background: linear-gradient(90deg,#c7b8ff,#e6d8ff); }

  /* score */
  #scoreDisplay{ background:#fff; border-radius:12px; padding:8px 12px; box-shadow:var(--shadow-soft); font-weight:900; font-size:16px; color:var(--text); border:1px solid var(--border-strong); }

  /* chat */
  .chatAreaWrap{border-radius:12px; overflow:hidden; border:1px solid var(--border-strong); background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,1)); display:flex; flex-direction:column; min-height:0; width:100%; overflow-x:hidden; }
  .chat{padding:12px 14px; overflow:auto; background:transparent; display:block; min-height:0; -webkit-overflow-scrolling:touch; width:100%; }
  .msgRow{display:flex; margin:8px 0; align-items:flex-end; gap:10px; width:100%}
  .msgBubble{padding:10px 14px; border-radius:14px; max-width:72%; word-break:break-word; box-shadow: 0 6px 18px rgba(2,6,23,0.04); border:1px solid rgba(0,0,0,0.06); overflow-wrap: break-word;}
  .msgBubble { max-width: calc(100vw - 140px); }
  .playerBubble{ background: linear-gradient(180deg, var(--player-bubble-bg), #cfeeff); color:var(--player-text); margin-left:auto; border-top-right-radius:6px; max-width: calc(100vw - 120px); }

  /* typing bubble */
  .typingBubble{ border-radius:12px; padding:10px 12px; display:inline-flex; align-items:center; gap:10px; border:2px solid rgba(0,0,0,0.06); max-width: calc(100vw - 140px); }
  .typingText{font-size:13px;color:var(--muted); font-weight:700}
  .dots{display:inline-flex; gap:6px}
  .dots span{ display:inline-block; width:8px; height:8px; border-radius:50%; background:rgba(36,19,50,0.16); transform:translateY(0); animation:dot 1s infinite; }
  @keyframes dot{ 0%{opacity:0.3; transform:translateY(0);} 50%{opacity:1; transform:translateY(-6px);} 100%{opacity:0.3; transform:translateY(0);} }

  /* controls */
  #controlArea{display:flex; gap:10px; align-items:center; padding:10px 0; flex-wrap:wrap}
  #playerInput{flex:1; min-width:0; padding:12px 14px;border-radius:12px;border:1px solid var(--border-strong); background:linear-gradient(180deg,#fff,#fffaf8); caret-color:var(--text); font-size:15px}
  #playerInput.noCaret{ caret-color: transparent; }
  #sendBtn{background:linear-gradient(90deg,#c7b8ff,#e6d8ff); color:var(--text); border:1px solid var(--border-strong); padding:10px 14px; border-radius:12px}
  button.small{padding:8px 10px; border-radius:10px; display:inline-flex; gap:8px; align-items:center; cursor:pointer; border:1px solid var(--border-strong); background:var(--card)}
  .btnIcon{width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:14px; border:1px solid var(--border-strong)}
  .btnLabel{ font-weight:800; margin-left:8px; font-size:14px; white-space:nowrap; }
  .safeIcon{background:linear-gradient(90deg,#b8f2d0,#9fe9c6); color:#064e3b}
  .dangerIcon{background:linear-gradient(90deg,#ffd6d6,#ffb4b4); color:#7f1d1d}
  .small.btn-correct{ background:linear-gradient(90deg,#d7fbe6,#b8f2d0); border-color:rgba(30,150,110,0.22); }
  .small.btn-wrong{ background:linear-gradient(90deg,#ffdede,#ffb4b4); border-color:rgba(220,80,80,0.18); }

  /* footer */
  .gameFooter{display:flex; gap:12px; align-items:flex-start; margin-top:8px; padding:6px}
  #dangerBoard{flex:1; padding:12px; background:linear-gradient(180deg,#fff7f7,#fff5f5); border:1px solid rgba(239,68,68,0.06); border-radius:12px; min-height:64px; color:#7f1d1d; overflow:auto; white-space:pre-wrap; word-break:break-word; max-height:160px}
  @media (max-width:520px){ #dangerBoard{ max-height:120px; width:100%; } .gameFooter{flex-direction:column;} }
  #levelEndNotice{min-width:220px; padding:12px; border-radius:12px; background:linear-gradient(180deg,#f3f0ff,#f9f7ff); border:1px solid rgba(111,66,193,0.06); color:var(--text); font-weight:700; display:none}

  /* next button */
  #nextBtn{position:fixed; right:22px; bottom:22px; z-index:200; display:none; padding:12px 20px; border-radius:14px; border:1px solid var(--border-strong); background:linear-gradient(90deg,#c7b8ff,#e6d8ff); color:var(--text); box-shadow:0 18px 46px rgba(111,66,193,0.12); font-weight:800}
  @media (max-width:520px){ #nextBtn{ position:static; display:none; margin-top:8px; align-self:flex-end } .op-center h2{ white-space:normal; } .op-right{ min-width:0; flex-direction:row-reverse; gap:8px } #scoreDisplay{ font-size:13px } }

  #restartFinalBtn{ background:linear-gradient(90deg,#ffd6a5,#fff0d6); color:var(--text); border:1px solid var(--border-strong); padding:10px 14px; border-radius:12px; font-weight:800 }

  /* confetti */
  #confetti{ position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:hidden; z-index:450 }
  .confetti-piece{ position:fixed; will-change:transform, top, opacity; border-radius:2px }

  /* MOBILE: stack header to save vertical space; title single-line */
  @media (max-width:520px){
    #opponentHeader{ flex-direction:column; align-items:center; gap:8px; padding:10px; }
    .op-center{ order:0; width:100%; }
    .op-center h2{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:15px; }
    .op-left{ order:1; display:flex; width:100%; justify-content:center; gap:8px; }
    .op-right{ order:2; display:flex; width:100%; justify-content:center; gap:8px; }
    .btnLabel{ margin-left:6px; font-size:13px; }
    .btnIcon{ width:26px; height:26px; font-size:13px; }
    #playerInput{ font-size:15px; padding:10px 12px; }
    #controlArea{ gap:8px; align-items:center; }
    .msgBubble, .typingBubble { max-width: calc(100vw - 60px); }
  }

  /* landscape small safety */
  @media (max-width:760px) and (orientation: landscape) {
    #opponentHeader { gap:6px; padding:8px; }
    .op-center h2 { font-size:14px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
    .msgBubble{ max-width: calc(100vw - 80px); }
    #playerInput{ max-width: calc(100% - 140px); }
    #nextBtn{ position:static; }
  }

  /* small visual hint for safeFocus */
  #playerInput.focus-hint { box-shadow: 0 0 0 8px rgba(99,102,241,0.08); transition: box-shadow 0.28s; }
</style>
</head>
<body>
<div class="page">
  <div class="container">
    <div id="gameCard" class="gameCard" role="main">

      <!-- HOME -->
      <div id="home">
        <div style="text-align:center">
          <h1>ç¶²è·¯äº¤å‹å®‰å…¨è¾¨è­˜éŠæˆ²</h1>
          <p class="lead">ç·´ç¿’åˆ¤æ–·å°è©±ä¸­çš„é¢¨éšªï¼Œä¿è­·å€‹äººè³‡æ–™èˆ‡éš±ç§ã€‚</p>
        </div>

        <div class="home-avatars" id="homeList" aria-hidden="false"></div>

        <div style="display:flex; gap:12px; justify-content:center; margin-top:8px">
          <button id="startBtn">é–‹å§‹éŠæˆ²</button>
        </div>
      </div>

      <!-- GAME -->
      <div id="game" style="display:none" aria-labelledby="levelTitle">

        <!-- DESKTOP ORDER: left (avatar/name), center (title), right (score/sound) -->
        <div id="opponentHeader">
          <div class="op-left">
            <div id="opAvatar" class="op-avatar">ğŸ±</div>
            <div style="display:flex; flex-direction:column;">
              <div id="opName" class="op-name">ç¶²å‹1</div>
              <div class="opSubtitle" id="opSubtitle">ç·šä¸Š</div>
            </div>
          </div>
          <div class="op-center"><h2 id="levelTitle">é—œå¡</h2></div>
          <div class="op-right">
            <div id="scoreDisplay">æœ¬é—œåˆ†æ•¸: 0 | ç´¯ç©åˆ†æ•¸: 0</div>
            <button id="soundBtn" class="sound-inline muted" title="åˆ‡æ›éŸ³æ•ˆ"><span id="soundIcon">ğŸ”‡</span></button>
          </div>
        </div>

        <div class="chatAreaWrap">
          <div class="chat" id="chatArea" aria-live="polite"></div>
        </div>

        <div id="controlArea">
          <button id="safeBtn" class="small"><span class="btnIcon safeIcon">âœ“</span><span class="btnLabel">å®‰å…¨</span></button>
          <button id="dangerBtn" class="small"><span class="btnIcon dangerIcon">!</span><span class="btnLabel">å±éšª</span></button>
          <input id="playerInput" type="text" class="noCaret" placeholder="å…ˆæŒ‰å®‰å…¨æˆ–å±éšªï¼Œå†è¼¸å…¥å›è¦†" disabled />
          <button id="sendBtn">é€å‡º</button>
        </div>

        <div class="gameFooter">
          <div id="dangerBoard" aria-live="polite">æš«ç„¡å±éšªæç¤º</div>
          <div id="levelEndNotice">æœ¬é—œå·²çµæŸï¼Œè«‹æŒ‰ã€Œä¸‹ä¸€é—œã€ã€‚</div>
        </div>

        <button id="nextBtn">ä¸‹ä¸€é—œ</button>
      </div>

      <!-- RESULT -->
      <div id="result" style="display:none">
        <h2>éŠæˆ²çµæŸ ğŸ‰</h2>
        <div id="finalScore" style="font-weight:800; margin-bottom:8px;"></div>
        <div id="finalMessage" style="margin-bottom:10px; font-weight:700;"></div>
        <div style="margin-bottom:10px;"><button id="restartFinalBtn">å›åˆ°é¦–é </button></div>
        <h3 style="margin-bottom:8px">å±éšªå°è©±æé†’ï¼ˆæ‰€æœ‰å±éšªå°è©±ï¼Œå«åŸå› ï¼‰</h3>
        <div id="dangerSummary" style="white-space:pre-line; padding:12px; background:#fff8f8; border:1px solid #f87171; border-radius:8px; max-height:60vh; overflow:auto;"></div>
      </div>

    </div>
  </div>
</div>

<div id="confetti"></div>

<!-- Audios -->
<audio id="bgMusic" loop src="assets/audio/strawberry-358303.mp3"></audio>
<audio id="correctSound" src="assets/audio/correct.mp3"></audio>
<audio id="wrongSound" src="assets/audio/error.mp3"></audio>
<audio id="perfectSound" src="assets/audio/perfect.mp3"></audio>
<audio id="multiPop" src="assets/audio/multi-pop.mp3"></audio>

<script>
/* é—œå¡è³‡æ–™ï¼ˆä¸è®Šï¼‰ */
const levelData = [
  { title:'ç¬¬ä¸€é—œ', opponent:{name:'ç¶²å‹1', avatar:'ğŸ±', color:'#ffcced'}, dialogues:[
      { text:'å—¨ï¼å‰›å‰›çœ‹åˆ°ä½ åˆ†äº«çš„è·‘æ­¥ç…§ç‰‡ï¼Œå¾ˆæœ‰æ´»åŠ›ï¼Œä½ å¸¸å»å“ªè£¡è·‘æ­¥ï¼Ÿ', danger:false },
      { text:'æˆ‘ä¸Šé€±åƒåŠ å­¸æ ¡çš„è·¯è·‘ï¼Œæƒ³çŸ¥é“ä½ å¹³å¸¸è¨“ç·´æ€éº¼å®‰æ’ï¼Ÿ', danger:false },
      { text:'å¯ä»¥æŠŠä½ çš„æ¯”è³½æˆç¸¾çµ¦æˆ‘çœ‹çœ‹å—ï¼Ÿæˆ‘æƒ³æ¯”è¼ƒä¸€ä¸‹ã€‚', danger:true, reason:'æ¯”è³½æˆç¸¾å±¬å€‹äººè³‡è¨Šï¼Œå¯èƒ½è¢«ç”¨ä¾†è©•åƒ¹æˆ–è¿½è¹¤' }
    ], answers:[], score:0 },
  { title:'ç¬¬äºŒé—œ', opponent:{name:'ç¶²å‹2', avatar:'ğŸ¶', color:'#bfeaff'}, dialogues:[
      { text:'å—¨ï½ä»Šå¤©æœ‰æ²’æœ‰ç™¼ç”Ÿä»€éº¼å¥½ç©çš„äº‹ï¼Ÿ', danger:false },
      { text:'æˆ‘è·Ÿæœ‹å‹æƒ³é€±æœ«å»é™„è¿‘é‚£å®¶å’–å•¡å»³ï¼Œä½ æœƒå»å—ï¼Ÿ', danger:false },
      { text:'å¦‚æœä½ ä½é™„è¿‘ï¼Œå¯ä»¥æ‹ä¸€ä¸‹ä½ å®¶å¤–é¢çš„è¡—æ™¯çµ¦æˆ‘çœ‹å—ï¼Ÿ', danger:false }
    ], answers:[], score:0 },
  { title:'ç¬¬ä¸‰é—œ', opponent:{name:'ç¶²å‹3', avatar:'ğŸ¦Š', color:'#c8facc'}, dialogues:[
      { text:'ä½ çš„è‡ªæ‹å¾ˆæœ‰ç‰¹è‰²ï¼Œæœ€è¿‘åœ¨ç”¨å“ªå€‹æ¿¾é¡ï¼Ÿ', danger:false },
      { text:'å¯ä»¥çµ¦æˆ‘ä¸€å¼µä½ å–®ç¨çš„ç§å¯†è‡ªæ‹å—ï¼Ÿæˆ‘å¾ˆæƒ³çœ‹çœŸå¯¦çš„ä½ ï½', danger:true, reason:'è¦æ±‚ç§äººç…§ç‰‡å¯èƒ½å°è‡´æ¿«ç”¨æˆ–å¤–æµ' },
      { text:'å¦‚æœä¸æ–¹ä¾¿ä¹Ÿæ²’é—œä¿‚ï¼Œæˆ‘å€‘å¯ä»¥å¤šèŠèŠèˆˆè¶£ã€‚', danger:false }
    ], answers:[], score:0 },
  { title:'ç¬¬å››é—œ', opponent:{name:'ç¶²å‹4', avatar:'ğŸ¼', color:'#fff6b3'}, dialogues:[
      { text:'å—¨ï¼Œæˆ‘å€‘éšŠç¼ºä¸€å€‹éšŠå‹ç©åˆä½œéŠæˆ²ï¼Œä½ æƒ³åŠ å…¥å—ï¼Ÿ', danger:false },
      { text:'æˆ‘å€‘é€šå¸¸å‘¨æœ«ç·´ä¸€å°æ™‚ï¼Œå¤§å®¶éƒ½å¾ˆå‹å–„ã€‚', danger:false },
      { text:'è«‹å•ä½ çš„éŠæˆ²æš±ç¨±æ˜¯ä»€éº¼ï¼Ÿï¼ˆä¸æ˜¯å¸³è™Ÿæˆ–å¯†ç¢¼ï¼‰', danger:false }
    ], answers:[], score:0 },
  { title:'ç¬¬äº”é—œ', opponent:{name:'ç¶²å‹5', avatar:'ğŸ¦„', color:'#ffd1ba'}, dialogues:[
      { text:'ä½ æœ€è¿‘æœ€å–œæ­¡çš„ç§‘ç›®æ˜¯ä»€éº¼ï¼Ÿ', danger:false },
      { text:'é€™å‘¨æœ«æœ‰ç¤¾åœ˜æ´»å‹•ï¼Œæœƒæœ‰å¾ˆå¤šåŒå­¸å‡ºå¸­ï¼Œæƒ³ä¸€å¡Šå»å—ï¼Ÿ', danger:false },
      { text:'ä½ ç¾åœ¨æœ‰åœ¨äº¤å¾€å—ï¼Ÿå¯ä»¥å‘Šè¨´æˆ‘å°æ–¹çš„åå­—å—ï¼Ÿ', danger:true, reason:'è©¢å•æ„Ÿæƒ…ç§äººè³‡è¨Šä¸é©åˆå…¬é–‹' }
    ], answers:[], score:0 }
];

let currentLevel=0, currentDialogue=0, choiceMade=false, cumulativeScore=0;
let soundEnabled=false, confettiActive=false;

/* audios */
const bgMusic = document.getElementById('bgMusic');
const correctSound = document.getElementById('correctSound');
const wrongSound = document.getElementById('wrongSound');
const perfectSound = document.getElementById('perfectSound');
const multiPop = document.getElementById('multiPop');

/* dom */
const gameCard=document.getElementById('gameCard');
const homeEl=document.getElementById('home'), gameEl=document.getElementById('game'), resultEl=document.getElementById('result');
const startBtn=document.getElementById('startBtn');
const opAvatarEl=document.getElementById('opAvatar'), opNameEl=document.getElementById('opName'), opSubtitle=document.getElementById('opSubtitle');
const chatArea=document.getElementById('chatArea'), playerInput=document.getElementById('playerInput'), sendBtn=document.getElementById('sendBtn');
const safeBtn=document.getElementById('safeBtn'), dangerBtn=document.getElementById('dangerBtn');
const dangerBoard=document.getElementById('dangerBoard'), levelEndNotice=document.getElementById('levelEndNotice');
const scoreDisplay=document.getElementById('scoreDisplay'), nextBtn=document.getElementById('nextBtn');
const resultScore=document.getElementById('finalScore'), resultMsg=document.getElementById('finalMessage'), dangerSummary=document.getElementById('dangerSummary');
const restartFinalBtn=document.getElementById('restartFinalBtn');
const soundBtn=document.getElementById('soundBtn');
const soundIcon=document.getElementById('soundIcon');
const homeList=document.getElementById('homeList');
const confettiEl=document.getElementById('confetti');

/* helpers */
function darken(hex, amt){ const h=hex.replace('#',''); const bigint=parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h,16); const r=(bigint>>16)&255,g=(bigint>>8)&255,b=bigint&255; const nr=Math.max(0,Math.min(255,Math.round(r*(1-amt)))), ng=Math.max(0,Math.min(255,Math.round(g*(1-amt)))), nb=Math.max(0,Math.min(255,Math.round(b*(1-amt)))); return `rgba(${nr},${ng},${nb},1)`; }
function rgba(hex,a){ const h=hex.replace('#',''); const bigint=parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h,16); const r=(bigint>>16)&255,g=(bigint>>8)&255,b=bigint&255; return `rgba(${r},${g},${b},${a})`; }

/* auto-focus helper: short delay + scroll-into-view protection */
function isMobileDevice(){ return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }
function safeFocus(el, opts = { delay: 300 }){
  if(!el) return;
  const d = typeof opts.delay === 'number' ? opts.delay : 300;
  setTimeout(()=>{
    try{
      el.focus();
      if(typeof el.scrollIntoView === 'function'){
        el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
      }
      if(isMobileDevice()){
        el.classList.add('focus-hint');
        setTimeout(()=> el.classList.remove('focus-hint'), 1500);
      }
    }catch(e){
      try{ el.focus(); }catch(err){}
    }
  }, d);
}

/* render home avatars */
function renderHomeAvatars(){ homeList.innerHTML=''; levelData.forEach((l,i)=>{ const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='center'; wrap.style.gap='6px'; const w=document.createElement('div'); w.className='home-avatar'; w.style.background = `linear-gradient(135deg, ${l.opponent.color}, #ffffffcc)`; w.style.border = '1px solid var(--border-strong)'; w.innerText = l.opponent.avatar; const label = document.createElement('div'); label.className='label'; label.innerText = 'ç¶²å‹' + (i+1); label.style.fontSize='12px'; label.style.color='var(--muted)'; wrap.appendChild(w); wrap.appendChild(label); homeList.appendChild(wrap); }); }

/* UI states */
function showHome(){ homeEl.style.display='flex'; gameEl.style.display='none'; resultEl.style.display='none'; scoreDisplay.style.display='none'; soundBtn.style.display='none'; gameCard.style.paddingBottom='16px'; renderHomeAvatars(); setTimeout(()=>{ gameCard.scrollTop = 0; }, 50); }
function showGame(){ homeEl.style.display='none'; gameEl.style.display='block'; resultEl.style.display='none'; scoreDisplay.style.display='block'; soundBtn.style.display='inline-flex'; setTimeout(()=>{ gameCard.scrollTop = 0; }, 50); }
function showResult(){ homeEl.style.display='none'; gameEl.style.display='none'; resultEl.style.display='block'; scoreDisplay.style.display='none'; soundBtn.style.display='inline-flex'; gameCard.style.paddingBottom='16px'; setTimeout(()=>{ gameCard.scrollTop = 0; }, 50); }

/* chat append */
function appendNpcWithTyping(text, avatar){
  if(!dangerBoard.innerText) dangerBoard.innerText='æš«ç„¡å±éšªæç¤º';
  const row=document.createElement('div'); row.className='msgRow';
  const avatarWrap=document.createElement('div'); avatarWrap.className='op-avatar'; avatarWrap.innerText=avatar;
  avatarWrap.style.background = window.currentNpcColor ? `linear-gradient(135deg, ${window.currentNpcColor}, #ffffffcc)` : '';
  const bubble=document.createElement('div'); bubble.className='typingBubble';
  const typingText=document.createElement('div'); typingText.className='typingText'; typingText.innerText='å°æ–¹æ­£åœ¨è¼¸å…¥â€¦';
  const dots=document.createElement('div'); dots.className='dots'; dots.innerHTML='<span></span><span></span><span></span>';
  bubble.appendChild(typingText); bubble.appendChild(dots);
  const col = window.currentNpcColor || '#e9eef8';
  bubble.style.background = `linear-gradient(180deg, ${col}, #ffffffcc)`;
  bubble.style.border = `2px solid ${rgba(darken(col,0.18),0.22)}`;
  row.appendChild(avatarWrap); row.appendChild(bubble); chatArea.appendChild(row);
  const base=600, perChar=30, maxTime=2200; const time=Math.min(base + (text.length * perChar), maxTime);
  return new Promise(resolve=>{ setTimeout(()=>{ bubble.className='msgBubble npcBubble'; bubble.innerText=text; bubble.style.background = `linear-gradient(180deg, ${col}, #ffffffcc)`; bubble.style.borderLeft = `4px solid ${rgba(darken(col,0.18),0.28)}`; const nearBottom = (chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight) < 80; if(nearBottom) chatArea.scrollTop = chatArea.scrollHeight; playSound(multiPop); resolve(); }, time); });
}

function appendPlayer(text){ const row=document.createElement('div'); row.className='msgRow'; const bubble=document.createElement('div'); bubble.className='msgBubble playerBubble'; bubble.innerText=text; row.appendChild(bubble); row.style.justifyContent='flex-end'; chatArea.appendChild(row); chatArea.scrollTop = chatArea.scrollHeight; playSound(multiPop); }

function updateScoreDisplay(){ const level=levelData[currentLevel]||{}; const cs=level.score||0; scoreDisplay.innerText=`æœ¬é—œåˆ†æ•¸: ${cs} | ç´¯ç©åˆ†æ•¸: ${cumulativeScore}`; }

function setOpponentStyle(color){ const darker=darken(color,0.18); const header=document.getElementById('opponentHeader'); header.style.background=`linear-gradient(90deg, ${rgba(darker,0.12)}, rgba(255,255,255,0))`; opAvatarEl.style.background=`linear-gradient(135deg, ${color}, #ffffffcc)`; opAvatarEl.style.border='1px solid var(--border-strong)'; window.currentNpcColor=color; }

function loadLevel(){
  chatArea.innerHTML=''; dangerBoard.innerText='æš«ç„¡å±éšªæç¤º'; nextBtn.style.display='none'; levelEndNotice.style.display='none';
  playerInput.value=''; playerInput.disabled=true; playerInput.readOnly=true; playerInput.classList.add('noCaret');
  safeBtn.classList.remove('btn-correct','btn-wrong'); dangerBtn.classList.remove('btn-correct','btn-wrong');
  choiceMade=false; currentDialogue=0;
  const level=levelData[currentLevel];
  opAvatarEl.innerText=level.opponent.avatar; opNameEl.innerText=level.opponent.name; opSubtitle.innerText='ç·šä¸Š';
  setOpponentStyle(level.opponent.color);
  const titleEl=document.getElementById('levelTitle'); const titleText=`${level.title}ï¼ˆç¬¬ ${currentLevel+1} é—œ / å…± ${levelData.length} é—œï¼‰`;
  titleEl.innerText=titleText; titleEl.title=titleText;
  updateScoreDisplay();
  appendNpcWithTyping(level.dialogues[currentDialogue].text, level.opponent.avatar).then(()=>{});
}

/* handle choice */
function handleChoice(isDanger){
  if(choiceMade) return;
  choiceMade=true;
  const level=levelData[currentLevel];
  const dlg=level.dialogues[currentDialogue];
  const correct=(dlg.danger===isDanger);
  level.answers[currentDialogue]=correct;
  if(correct){
    playSound(correctSound);
  } else {
    playSound(wrongSound);
    if(dlg.danger && !isDanger){
      const tip=`âŒ ç¬¬${currentDialogue+1}é¡Œï¼š${dlg.text}\nå…¶å¯¦é€™æ˜¯å±éšªçš„ï¼ŒåŸå› ï¼š${dlg.reason||'ç„¡'}\n\n`;
      dangerBoard.innerText = (dangerBoard.innerText==='æš«ç„¡å±éšªæç¤º'?'':dangerBoard.innerText) + tip;
      dangerBoard.scrollTop = dangerBoard.scrollHeight;
      showToast('ç™¼ç¾æœªæ³¨æ„åˆ°çš„å±éšª â€” å·²åœ¨æé†’å€è¨˜éŒ„',2200);
    }
    if(!dlg.danger && isDanger){
      showToast('åˆ¤æ–·ç‚ºã€Œå±éšªã€ä½†æ­¤å›æ‡‰å¯¦éš›ç‚ºå®‰å…¨ â€” æ­¤èª¤åˆ¤ä¸æœƒåˆ—å…¥é—œå¡ç¸½çµ',3600);
    }
  }
  const btn=isDanger?dangerBtn:safeBtn;
  safeBtn.classList.remove('btn-correct','btn-wrong'); dangerBtn.classList.remove('btn-correct','btn-wrong');
  btn.classList.add(correct? 'btn-correct' : 'btn-wrong');

  playerInput.disabled=false; playerInput.readOnly=false; playerInput.classList.remove('noCaret');
  safeFocus(playerInput, { delay: 300 });
}

/* send input */
function sendPlayerInput(){
  if(!choiceMade) return;
  const val=playerInput.value.trim(); if(!val) return;
  appendPlayer(val);
  playerInput.value=''; playerInput.disabled=true; playerInput.readOnly=true; playerInput.classList.add('noCaret');
  safeBtn.classList.remove('btn-correct','btn-wrong'); dangerBtn.classList.remove('btn-correct','btn-wrong');
  choiceMade=false; currentDialogue++;
  const level=levelData[currentLevel];
  if(currentDialogue<level.dialogues.length){
    appendNpcWithTyping(level.dialogues[currentDialogue].text, level.opponent.avatar).then(()=>{});
  } else {
    const allCorrect = level.answers.length===level.dialogues.length && level.answers.every(x=>x===true);
    level.score = allCorrect ? 20 : 0;
    if(allCorrect){ playSound(perfectSound); showConfetti(); }
    cumulativeScore += level.score;
    updateScoreDisplay();
    let errors=''; level.dialogues.forEach((d,i)=>{ if(d.danger && !level.answers[i]) { errors+=`âŒ ç¬¬${i+1}é¡Œï¼š${d.text} åŸå› ï¼š${d.reason||'ç„¡'}\n\n`; } });
    dangerBoard.innerText = errors || 'æœ¬é—œç„¡éŒ¯èª¤ï¼';
    dangerBoard.scrollTop = dangerBoard.scrollHeight;
    if(currentLevel < levelData.length - 1){
      nextBtn.style.display='block'; levelEndNotice.style.display='block'; levelEndNotice.innerText='æœ¬é—œå·²çµæŸï¼Œè«‹æŒ‰ã€Œä¸‹ä¸€é—œã€ã€‚';
      if(window.matchMedia('(max-width:520px)').matches){ nextBtn.style.position='static'; } else { nextBtn.style.position='fixed'; gameCard.style.paddingBottom='120px'; }
      nextBtn.dataset.type='next'; nextBtn.innerText='ä¸‹ä¸€é—œ'; nextBtn.focus();
    } else {
      nextBtn.style.display='block'; levelEndNotice.style.display='block'; levelEndNotice.innerText='éŠæˆ²å·²çµæŸï¼Œè«‹æŒ‰ã€ŒéŠæˆ²çµæŸã€ã€‚';
      nextBtn.dataset.type='finish'; nextBtn.innerText='éŠæˆ²çµæŸ';
      if(window.matchMedia('(max-width:520px)').matches){ nextBtn.style.position='static'; } else { nextBtn.style.position='fixed'; gameCard.style.paddingBottom='120px'; }
      nextBtn.focus();
    }
  }
}

/* confetti */
function showConfetti(){ confettiActive=true; confettiEl.innerHTML=''; const colors=['#ff7ab6','#ffd166','#c7f9cc','#a7d8ff','#ffd1ba','#e6d8ff']; const rows=5; const perRow=24; for(let r=0;r<rows;r++){ const delayBase = r * 120; for(let i=0;i<perRow;i++){ const e=document.createElement('div'); e.className='confetti-piece'; const left = (i/perRow*100) + (Math.random()*3); e.style.left = left + '%'; e.style.top = (-10 - r*6) + 'vh'; e.style.width = (6 + Math.random()*14) + 'px'; e.style.height = (8 + Math.random()*26) + 'px'; e.style.background = colors[Math.floor(Math.random()*colors.length)]; e.style.opacity = 0.95; e.style.transform = 'rotate('+(Math.random()*360)+'deg)'; e.style.transition = `transform 3.4s linear ${delayBase}ms, top 3.4s linear ${delayBase}ms, opacity 3.4s linear ${delayBase}ms`; confettiEl.appendChild(e); setTimeout(()=>{ try{ e.style.top = (110 + Math.random()*10) + 'vh'; e.style.transform = 'rotate('+(720+Math.random()*720)+'deg)'; e.style.opacity = 0.95; }catch(err){} }, 50 + delayBase); setTimeout(()=>{ try{ if(confettiEl.contains(e)) confettiEl.removeChild(e); }catch(err){} }, 3800 + delayBase); } } setTimeout(()=>{ confettiActive=false; gameCard.style.paddingBottom='16px'; }, 5000); }

function playSound(el){ if(!soundEnabled) return; try{ const src = el && el.getAttribute && el.getAttribute('src'); if(!src) return; const s = new Audio(src); s.volume = 0.24; s.play().catch(()=>{}); }catch(e){} }

function saveRecordAndShowResult(){ let summary=''; levelData.forEach((lvl,li)=>{ lvl.dialogues.forEach((d,di)=>{ if(d.danger){ const answered=Array.isArray(lvl.answers)?!!lvl.answers[di]:false; summary+=`ç¬¬${li+1}é—œ ç¬¬${di+1}é¡Œ: ${d.text}\nâš ï¸ å±éšªåŸå› : ${d.reason||'ç„¡'}\nåˆ¤æ–·: ${answered? 'âœ… ä½ åˆ¤æ–·ç‚ºå±éšª (æ­£ç¢º)' : 'âŒ ä½ åˆ¤æ–·éŒ¯èª¤æˆ–æœªåˆ¤æ–·ç‚ºå±éšª'}\n\n`; } }); }); resultScore.innerText=`ä½ çš„ç¸½åˆ†æ˜¯ï¼š${cumulativeScore}`; const normalized = [0,20,40,60,80,100].includes(cumulativeScore) ? cumulativeScore : (cumulativeScore<20?0:(cumulativeScore<40?20:(cumulativeScore<60?40:(cumulativeScore<80?60:(cumulativeScore<100?80:100))))); const feedbacks = { 0: {title:'åˆ†æ•¸ï¼š0 â€” å†åŠ æ²¹ï¼', msg:'å¤šæ³¨æ„å€‹äººè³‡æ–™èˆ‡ç§å¯†ç…§ç‰‡ä¿è­·ï¼Œè«‹é¿å…åˆ†äº«å…·æœ‰è­˜åˆ¥æ€§çš„è³‡è¨Šã€‚', tips:['ä¸è¦åˆ†äº«åœ°å€ã€å­¸æ ¡æˆ–æ¯”è³½æˆç¸¾ç­‰å®šä½è³‡è¨Š','é‡åˆ°è¦æ±‚ç§äººç…§ç‰‡æˆ–è©³ç´°åœ°å€æ™‚æ‡‰ç«‹å³åœæ­¢åˆ†äº«','ä½¿ç”¨å¹³å°å…§çš„åŒ¿åæˆ–ç§å¯†è¨­å®šä¿è­·å€‹è³‡']}, 20: {title:'åˆ†æ•¸ï¼š20 â€” é‚„å¯ä»¥æ›´å¥½', msg:'ç•™å¿ƒå°æ–¹è¦æ±‚çš„å€‹äººè³‡è¨Šï¼Œåˆ¥è¼•æ˜“åˆ†äº«ã€‚', tips:['å°æ–¼ä¸ç†Ÿæ‚‰çš„äººï¼Œä¿æŒåŸºæœ¬ç¦®è²Œä½†ä¿ç•™å€‹è³‡','é‡åˆ°è¦æ±‚å¯¦é«”åœ°å€æˆ–ç§å¯†ç…§ç‰‡æ™‚å¤šå•å•é¡Œä¸¦ä¿æŒè·é›¢','å¯ä½¿ç”¨æ¨¡ç³Šç…§ç‰‡æˆ–ä¸é€éœ²ç´°ç¯€ä¾†ä¿è­·éš±ç§']}, 40: {title:'åˆ†æ•¸ï¼š40 â€” åšå¾—ä¸éŒ¯', msg:'å·²æœ‰è­¦è¦ºï¼Œä½†é‚„æœ‰éœ€è¦åŠ å¼·çš„åœ°æ–¹ã€‚', tips:['æ³¨æ„å°æ–¹æ˜¯å¦æŒçºŒç´¢å–æ›´å¤šç§å¯†è³‡è¨Š','å®šæœŸæª¢è¦–èˆ‡åˆªé™¤ä¸å¿…è¦çš„å€‹äººåˆ†äº«å…§å®¹','è‹¥å°æ–¹æœ‰å¨è„…æˆ–æåš‡è¡Œç‚ºï¼Œç«‹å³åœæ­¢ä¸¦æˆªåœ–å­˜è­‰']}, 60: {title:'åˆ†æ•¸ï¼š60 â€” å¾ˆå¥½', msg:'æœ‰æ³¨æ„åˆ°å¤šæ•¸å±éšªè¨Šè™Ÿï¼Œç¹¼çºŒä¿æŒã€‚', tips:['ä½¿ç”¨éš±ç§è¨­å®šé™åˆ¶çœ‹åˆ°ä½ è©³ç´°è¨Šæ¯çš„äºº','ç•¶æœ‰äººè¦æ±‚è¦‹é¢æˆ–ç´¢å–ç…§ç‰‡æ™‚ï¼Œå…ˆåœ¨å¹³å°ä¸Šå¤šèŠèˆ‡æ ¸å¯¦å°æ–¹èº«åˆ†','èˆ‡æœ‹å‹è¨è«–å¯ç–‘æƒ…æ³ï¼Œå°‹æ±‚ç¬¬äºŒæ„è¦‹']}, 80: {title:'åˆ†æ•¸ï¼š80 â€” éå¸¸æ£’ï¼', msg:'å·²å…·å‚™è‰¯å¥½ç¶²è·¯å®‰å…¨è§€å¿µã€‚', tips:['æŒçºŒç¶­æŒç•Œç·šï¼Œä¸è¦å› ç‚ºè®šç¾æˆ–å£“åŠ›è€Œåˆ†äº«ç§å¯†è³‡è¨Š','æ•™æœƒèº«é‚ŠäººåŒæ¨£çš„å®ˆå‰‡','ç•¶ä½ ç™¼ç¾ä»–äººå—é¨™ï¼Œæä¾›åˆé©å”åŠ©èˆ‡æª¢èˆ‰']}, 100: {title:'åˆ†æ•¸ï¼š100 â€” å®Œç¾ï¼', msg:'å®Œå…¨åˆ¤æ–·æ­£ç¢ºï¼Œæ­å–œä½ ï¼', tips:['ä½ å·²å…·å‚™å„ªç§€çš„ç¶²è·¯å®‰å…¨æ„è­˜','åˆ†äº«é€™äº›è§€å¿µçµ¦èº«é‚Šäºº','ä¿æŒè­¦è¦ºå¿ƒä¸¦é¼“å‹µä»–äººä¸€èµ·å­¸ç¿’']} }; const fb = feedbacks[normalized] || feedbacks[0]; resultMsg.innerText = fb.title + '\n' + fb.msg + '\n\nå»ºè­°:\n' + fb.tips.map((t,i)=>`${i+1}. ${t}`).join('\n'); dangerSummary.innerText = summary || 'æ²’æœ‰å±éšªå°è©±'; if(normalized === 100){ playSound(perfectSound); showConfetti(); } showResult(); }

/* toast */
function showToast(msg,duration=3000){ let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='24px'; t.style.transform='translateX(-50%)'; t.style.background='rgba(36,19,50,0.95)'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='12px'; t.style.zIndex=9999; document.body.appendChild(t); } t.innerText=msg; t.style.display='block'; clearTimeout(t._timer); t._timer=setTimeout(()=>{ t.style.display='none'; }, duration); }

/* events */
const startBtnEl = document.getElementById('startBtn');
startBtnEl.addEventListener('click', ()=>{
  levelData.forEach(l=>{ l.answers=[]; l.score=0; });
  currentLevel=0; currentDialogue=0; choiceMade=false; cumulativeScore=0;
  soundEnabled = true;
  if(soundBtn){ soundBtn.classList.remove('muted'); soundBtn.classList.add('on'); soundBtn.setAttribute('aria-pressed','true'); }
  if(soundIcon) soundIcon.innerText = 'ğŸ”Š';
  try{ bgMusic.volume=0.08; bgMusic.play().catch(()=>{}); }catch(e){}
  showGame(); loadLevel();
});

soundBtn.addEventListener('click', ()=>{ soundEnabled=!soundEnabled; if(soundEnabled){ soundBtn.classList.remove('muted'); soundBtn.classList.add('on'); soundBtn.setAttribute('aria-pressed','true'); if(soundIcon) soundIcon.innerText='ğŸ”Š'; try{ bgMusic.volume=0.08; bgMusic.play().catch(()=>{}); }catch(e){} } else { soundBtn.classList.remove('on'); soundBtn.classList.add('muted'); soundBtn.setAttribute('aria-pressed','false'); if(soundIcon) soundIcon.innerText='ğŸ”‡'; try{ bgMusic.pause(); bgMusic.currentTime=0; }catch(e){} } });

safeBtn.addEventListener('click', ()=>handleChoice(false));
dangerBtn.addEventListener('click', ()=>handleChoice(true));
sendBtn.addEventListener('click', sendPlayerInput);
playerInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendPlayerInput(); });

nextBtn.addEventListener('click', ()=>{ const t = nextBtn.dataset.type || 'next'; if(t === 'next'){ if(confettiActive){ confettiActive=false; confettiEl.innerHTML=''; setTimeout(()=>{ nextBtn.style.display='none'; gameCard.style.paddingBottom='16px'; currentLevel++; loadLevel(); },120); } else { nextBtn.style.display='none'; gameCard.style.paddingBottom='16px'; currentLevel++; loadLevel(); } } else { if(confettiActive){ confettiActive=false; confettiEl.innerHTML=''; setTimeout(()=>{ saveRecordAndShowResult(); },120); } else saveRecordAndShowResult(); } });

restartFinalBtn.addEventListener('click', ()=>{ levelData.forEach(l=>{ l.answers=[]; l.score=0; }); currentLevel=0; currentDialogue=0; choiceMade=false; cumulativeScore=0; try{ bgMusic.pause(); bgMusic.currentTime=0; }catch(e){} soundEnabled=false; if(soundBtn){ soundBtn.classList.remove('on'); soundBtn.classList.add('muted'); if(soundIcon) soundIcon.innerText='ğŸ”‡'; } showHome(); });

/* init */
renderHomeAvatars(); showHome();

/* resize safety */
window.addEventListener('resize', ()=>{ try{ if(nextBtn.style.display==='block' && nextBtn.dataset.type){ if(!window.matchMedia('(max-width:520px)').matches) gameCard.style.paddingBottom='120px'; } }catch(e){} });

</script>
</body>
</html>
